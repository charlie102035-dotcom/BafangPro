# A Team Shared Log

## Rules
- 每位 agent 只能在自己的區塊「追加」內容，不可修改他人區塊。
- 每次更新都要包含時間（本地時間）與 Round 編號。
- 最少包含：修改檔案、完成摘要、測試命令、測試結果、風險。

---

## A1 資料契約官
### 2026-02-15 04:19:48 +0800 | Round 1 (Ingest 串接) | 狀態: 部分完成（契約已定義，現有 llm fallback 測試阻塞）
- 修改檔案
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/contracts.py`
  - `/Users/charlie/bafang-box-order/server/services/pos_pipeline/schema.mjs`（新建）
- 完成摘要
  - 定義跨層 ingest/review/dispatch 契約：`IngestRequest/IngestResponse`、`ReviewRequest/ReviewResponse`、`DispatchRequest/DispatchResponse`。
  - 新增 `ReviewQueueStatusLiteral`、`ReviewDecisionLiteral`、`DispatchStatusLiteral`、`AuditTrace`、`ReviewSummary`、`OrderNormalizedPayload`。
  - 新增 internal payload：`PipelineInternalPayload`（串接 `order_raw -> candidates -> structured_result -> order_normalized`）。
  - Node 端新增 `/server/services/pos_pipeline/schema.mjs`，提供同名契約枚舉、欄位文件、及 request/response/order payload 驗證函式，對齊 Python `OrderNormalized` 並覆蓋：
    - `overall_needs_review`
    - item/group `needs_review`
    - `audit_trace_id`
    - `review_queue_status`
- 測試命令
  - `python3 -m py_compile /Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/contracts.py`
  - `node --check /Users/charlie/bafang-box-order/server/services/pos_pipeline/schema.mjs`
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests`
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests -k "not llm_pipeline and not contract_compat and not end_to_end"`
- 測試結果
  - `py_compile`: 通過
  - `node --check`: 通過
  - 全量 pytest: `6 failed, 80 passed`（失敗集中於既有 `llm_pipeline` fallback 呼叫缺少 `fallback_reason` 參數）
  - 排除 `llm_pipeline/contract_compat/end_to_end` 後：`70 passed, 16 deselected`
- 風險
  - 目前 `llm_pipeline.py` 既有缺陷會導致 fallback 路徑失敗（非本輪白名單可修），影響全量 Python 測試全綠。
  - 新增契約未改動核心欄位語意，但下游若未同步使用 `OrderNormalizedPayload`，仍可能出現欄位命名分歧。
### 2026-02-15 04:45:36 +0800 | Round 3 (POS ingest/review API 契約補齊) | 狀態: 完成
- 修改檔案
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/contracts.py`
  - `/Users/charlie/bafang-box-order/server/services/pos_pipeline/schema.mjs`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/contract/test_contract_compat.py`
- 完成摘要
  - 契約版本鎖定：保留核心資料契約 `CONTRACT_VERSION=1.0.0`，新增 API 契約版本 `API_CONTRACT_VERSION=1.1.0`。
  - 補齊 ingest/review 契約：
    - ingest request/response：新增 `api_version`、`version`，並明確保留 backward-compatible 可選欄位 `text`、`status`、`trace_id`。
    - review list response：新增 `ReviewListItem`、`ReviewListResponse`（含 `overall_needs_review`、needs_review counts、queue status、trace id）。
    - review decision request/response：新增 `api_version` 必填，並保留 response `status` 可選相容欄位。
  - Node schema 同步補齊對應驗證器：`validateReviewListResponse` 與版本一致性檢查（`api_version`/`version` 必須匹配鎖定版本）。
  - 新增 contract 測試：覆蓋 ingest request/response、review list response、review decision request/response 與可選相容欄位。
- 測試命令
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/contract/test_contract_compat.py`
  - `node --check /Users/charlie/bafang-box-order/server/services/pos_pipeline/schema.mjs`
- 測試結果
  - `3 passed in 0.31s`
  - `node --check` 通過
- 風險
  - 目前 contract 測試使用 Node 子程序調 schema validator，若執行環境 PATH 缺少 node，pytest 會失敗（已在測試內保留系統環境變數避免 PATH 被覆蓋）。

## A2 印單解析官

- 時間：2026-02-15 04:18:39 CST
- Round：Round 1 (Ingest 串接)
- 狀態：完成
- 修改檔案：
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/parser.py`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_parser.py`
- 修正摘要：
  - 收斂雜訊判定：保留電話/地址/時間/單號等雜訊行跳過規則，同時避免「含明確 qty 的行」被前綴規則誤刪。
  - 強化 qty 擷取：先判 `x/*`、`N份`，再判純數量；若偵測到 qty 痕跡但格式破損，保守標記 invalid/missing 並回退 `qty=1` + `needs_review=true`。
  - 新增尾端金額相容：支援 `x2 120`、`3份 NT$90`、`*2 40元` 先去尾端金額再抽 qty，避免誤把金額當數量。
  - 解析不確定時確保可追溯：保留 `raw_line` / `name_raw` / `note_raw`，並落 `needs_review=true`。
- 測試命令：
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_parser.py`
- 測試結果：
  - `16 passed in 0.02s`
- 風險：
  - 極端混排（同一行多品項、跨行語義）仍可能只能保守落到 `needs_review=true`，需人工複核。

## A3 候選比對官

- 時間：2026-02-15 04:17:47 CST
- Round：Round 1, Ingest 串接
- 狀態：完成
- 修改檔案：
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/candidates.py`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_candidates.py`
- 修正摘要：
  - 強化 menu_catalog ingest 相容：dict/list 皆支援 `item_id` / `id`，dict payload 若含 `item_id` 可覆蓋 mapping key。
  - 支援 `alias` 單數欄位與 aliases 映射型別，降低真實資料格式差異造成的漏匹配。
  - candidate_code 防空值：空白/缺失 item_id 會回退到 canonical/name/`list_item_{index}`，避免下游無法落單。
  - 低信心可解釋資訊補強：新增 `metadata.review_reason`（低分為 `best_score_below_threshold`）。
- 測試命令：`pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_candidates.py`
- 測試結果：`19 passed in 0.03s`
- 風險：
  - 目前環境未安裝 rapidfuzz，僅驗證到標準庫 fallback 分支。

## A4 LLM判定官
- 時間：2026-02-15 04:30:28 CST
- Round：Round 1（Ingest 串接）
- 狀態：完成
- 修改檔案：
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/llm_pipeline.py`
  - `/Users/charlie/bafang-box-order/python_pos_module/prompts/normalize_group.prompt.md`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_llm_pipeline.py`
- 修正摘要：
  - 強化 ingest fallback：timeout / timeout-like error / API error / JSON parse retry-fail 都可穩定回退，並落 `fallback_reason` 與 audit 事件。
  - 強化越權攔截：
    - `item_id` 缺失或不在候選：回退第一候選並標 `needs_review`。
    - `mods` 非 list 或含未授權 mod：過濾並標 `needs_review`，寫入 policy_violation audit tags。
    - `groups` 非法 payload、越界 line indices、非法 type、不足兩行、重複 group：全數攔截/降級並保留 audit。
  - 補 review queue 可用訊息：新增 `metadata.review_queue`（`needs_review` / `reasons` / `audit_tags`），且 item/group metadata 追加 `review_reasons`、`review_tags`。
  - 指代分組回補維持：LLM 漏判時由 rule backstop 補 `上面兩項同袋` 類型群組。
- 測試命令：
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_llm_pipeline.py`
- 測試結果：
  - `13 passed in 0.04s`
- 風險：
  - 指代規則仍以關鍵字為主，未覆蓋所有自然語言變體；未命中的情況會保守落 `needs_review`。
- 時間：2026-02-15 04:45:57 CST
- Round：Round 3（Production-safe for ingest API）
- 狀態：完成
- 修改檔案：
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/llm_pipeline.py`
  - `/Users/charlie/bafang-box-order/python_pos_module/prompts/normalize_group.prompt.md`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_llm_pipeline.py`
- 修正摘要：
  - 補強 review queue 聚合：`metadata.review_queue` 的 `needs_review` 現在會納入 audit tags（`policy_violation` / `review_queue`）與風險事件映射，避免僅有審計告警時漏進人工審核。
  - fallback 可追溯性收斂：無 LLM client、timeout、JSON parse retry fail、API error 均可穩定回退，並在 metadata 與 audit 留下原因與標籤。
  - 越權攔截維持嚴格：item/mod/group 的 payload/type/line_indices 越權都會被攔截、降級或過濾，且補齊 policy_violation tags。
  - 單元測試改為測試內注入 `pos_norm.contracts` stub，避免既有 `contracts.py` 語法錯誤阻斷本輪 LLM 路徑驗證（不修改契約檔本身）。
  - 新增回歸案例：`llm_client_missing` fallback、`invalid_groups_payload` 僅靠 audit 也會觸發 review queue。
- 測試命令：
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_llm_pipeline.py`
- 測試結果：
  - `15 passed in 0.03s`
- 風險：
  - 測試使用 contracts stub 僅保證 LLM pipeline 行為；若要驗證全鏈路仍需先修復 `contracts.py` 的語法錯誤（本輪白名單外）。

## A5 結果驗收官
- 時間：2026-02-15 04:19:00 CST
- Round：Round 1（Ingest 串接）
- 狀態：完成
- 修改檔案：
  - `/Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/merge_validate.py`
  - `/Users/charlie/bafang-box-order/server/services/order_dispatch/dispatcher.mjs`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_merge_validate.py`
  - `/Users/charlie/bafang-box-order/python_pos_module/tests/integration/test_end_to_end.py`
- 完成摘要：
  - 定稿分流規則：任一不確定/needs_review（含 overall、item/group、缺 item_code、qty 異常）一律 `review-queue`，否則 `auto-dispatch`。
  - `merge_and_validate` metadata 新增 `dispatch_decision`，後端可直接讀取 `route` 與 `should_auto_dispatch`。
  - 新增 `dispatcher.mjs`，可直接用 merge 結果決策分流，並在 metadata 缺失時做保守 fallback。
  - integration 改為實際呼叫 Node dispatcher 驗證 `review-queue` 與 `auto-dispatch` 兩條路徑。
- 測試命令：
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_merge_validate.py`
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/integration/test_end_to_end.py`
- 測試結果：
  - `16 passed`
  - `2 passed`
- 風險：
  - `python_pos_module/src/pos_norm/llm_pipeline.py` 目前 fallback path 仍有介面不一致（本輪白名單外），本次 integration 已避開該缺陷並完成分流驗證。
- 時間：2026-02-15 04:47:55 CST
- Round：Round-3（orders API 正式掛載）
- 狀態：完成
- 修改檔案：
  - `/Users/charlie/bafang-box-order/server/index.mjs`
  - `/Users/charlie/bafang-box-order/server/routes/orders.mjs`
  - `/Users/charlie/bafang-box-order/server/services/pos_pipeline/review_service.mjs`
  - `/Users/charlie/bafang-box-order/server/services/pos_pipeline/ingest_service.mjs`
  - `/Users/charlie/bafang-box-order/server/tests/orders_api.smoke.sh`
- 完成摘要：
  - 新增並掛載路由：`POST /api/orders/ingest-pos-text`、`GET /api/orders/review`、`POST /api/orders/review/decision`。
  - 串接既有模組：
    - `schema.mjs`：所有 ingest/review request/response 走 contract validation。
    - `audit_store.mjs`：ingest pipeline trace 與 review decision/manual correction 審計落地。
    - `dispatcher.mjs`：以 `classifyOrderDispatch` 做 auto-dispatch vs review-queue 決策。
  - 回傳格式同時支援：
    - 前端可直接讀的 `pendingReview` / `tracking`。
    - schema 定義的 `items/total/page/page_size/...` 與 `order_payload`。
  - 已修復前端 404 根因：`/api/orders/review` 已存在並回 200。
- 測試命令：
  - `chmod +x /Users/charlie/bafang-box-order/server/tests/orders_api.smoke.sh && /Users/charlie/bafang-box-order/server/tests/orders_api.smoke.sh`
  - `node --check /Users/charlie/bafang-box-order/server/index.mjs`
  - `node --check /Users/charlie/bafang-box-order/server/routes/orders.mjs`
  - `node --check /Users/charlie/bafang-box-order/server/services/pos_pipeline/ingest_service.mjs`
  - `node --check /Users/charlie/bafang-box-order/server/services/pos_pipeline/review_service.mjs`
- 測試結果：
  - smoke：
    - `POST /api/orders/ingest-pos-text` → `200`（非 404）
    - `GET /api/orders/review` → `200`（非 404）
    - `POST /api/orders/review/decision` → `200`（非 404）
  - `node --check` 全通過
- 風險：
  - ingest 目前使用 Node 端簡化 parsing（非 Python pipeline 直連），可用於主流程串接與分流，但語義精度仍依後續 Python 服務化整合提升。

## A6 快取稽核官

- 時間：2026-02-15 04:31:02 +0800
- Round：Round 1（Ingest 串接）
- 狀態：完成
- 修改檔案：
  - /Users/charlie/bafang-box-order/python_pos_module/src/pos_norm/audit.py
  - /Users/charlie/bafang-box-order/python_pos_module/fixtures/receipts.json
  - /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_cache_audit.py
  - /Users/charlie/bafang-box-order/server/services/pos_pipeline/cache_store.mjs
  - /Users/charlie/bafang-box-order/server/services/pos_pipeline/audit_store.mjs
- 落地結構摘要：
  - 新增 ingest 端 `cache_store.mjs`：三 namespace、版本欄位必填、TTL 自動失效、檔案持久化、invalidate。
  - 新增 ingest 端 `audit_store.mjs`：append-only JSONL、`appendPipelineTrace`、`appendManualCorrection`、`getOrderTrace`、`listReviewQueue`（支援 unresolved only）。
  - Python `audit.py` 對齊補強：`merge_result`/`needs_review` 欄位、`get_order_trace`、`list_review_queue`。
  - fixtures `receipts.json` 新增 `manual_fix_example` 與 `expected_audit_stages`，可直接支援 integration。
- 測試命令：
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_cache_audit.py`
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit`
  - `node --input-type=module ...`（smoke test：cache TTL + audit review queue）
- 測試結果：
  - `test_cache_audit.py`：21 passed
  - `tests/unit`：85 passed
  - Node smoke：ok
- 風險：
  - `server/services/pos_pipeline/*_store.mjs` 目前為檔案型實作，尚未做跨程序鎖定；高併發寫入需後續評估。

- 時間：2026-02-15 04:46:02 +0800
- Round：Round-3（ingest/review cache + audit 落地追溯）
- 狀態：完成
- 修改檔案：
  - /Users/charlie/bafang-box-order/server/services/pos_pipeline/cache_store.mjs
  - /Users/charlie/bafang-box-order/server/services/pos_pipeline/audit_store.mjs
  - /Users/charlie/bafang-box-order/server/tests/cache_audit.smoke.sh
  - /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_cache_audit.py
- 落地結構摘要：
  - `cache_store.mjs` 新增 `getWithTrace` / `setWithTrace`，在 ingest/review 查詢與寫入時可直接寫入 `cache_hit` / `cache_miss` / `cache_write` audit event，並攜帶 namespace、stage、version key metadata。
  - `audit_store.mjs` 新增 `appendDispatchDecision`、`appendReviewDecision`、`appendCacheLookup`、`appendCacheWrite`，讓 trace 串起 ingest -> dispatch -> review decision -> manual correction。
  - `cache_audit.smoke.sh` 新建並驗證：三 cache namespace hit/miss、TTL miss、version miss、全流程 trace、`unresolvedOnly` 過濾、manual correction 解決狀態。
  - `test_cache_audit.py` 新增 `dispatch_decision`/`review_decision` queue 行為測試，確認 manual correction 後 unresolved queue 正確排除。
- 測試命令：
  - `pytest -q /Users/charlie/bafang-box-order/python_pos_module/tests/unit/test_cache_audit.py`
  - `/Users/charlie/bafang-box-order/server/tests/cache_audit.smoke.sh`
- 測試結果：
  - `22 passed`
  - `cache_audit smoke: PASS`
- 風險：
  - audit/cache 目前為 file-based store，跨程序並發寫入仍缺原子鎖定策略；高併發環境需後續改為 DB/lock 實作。
